---
- name: wireguard client
  hosts: all
  tasks:

    - name: Packages for wireguard
      apt:
        name:
          - wireguard
          - network-manager
        update_cache: no
        install_recommends: no

    - name: activate wireguard logging
      blockinfile:
        path: /etc/modprobe.d/wireguard.conf
        create: yes
        mode: "0444"
        owner: root
        group: root
        marker: "# {mark} ANSIBLE MANAGED BLOCK for wireguard"
        insertbefore: BOF
        block: |
          options wireguard dyndbg=+p
          
    - name: load wireguard module during boot
      blockinfile:
        path: /etc/modules-load.d/wireguard.conf
        create: yes
        mode: "0444"
        owner: root
        group: root
        marker: "# {mark} ANSIBLE MANAGED BLOCK for wireguard"
        insertbefore: BOF
        block: |
          wireguard
          
    - name: /usr/local/sbin/wireguard.sh
      blockinfile:
        path: /usr/local/sbin/wireguard.sh
        create: yes
        mode: 0500
        owner: root
        group: root
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
        block: |
          . /etc/bash/gaboshlib.include

          g_echo "=== Starting $0"

          userhome=$(getent passwd 1000 | cut -d: -f6)
          wireguard_configs="${userhome}/wg-client.conf ${userhome}/.config/wg-client.conf ${userhome}/.wg-client.conf/root/wg-client.conf /usr/local/etc/wg-client.conf /etc/wg-client.conf"
          for wireguard_config in $wireguard_configs
          do
            [ -s $wireguard_config ] && break
          done
          if ! [ -s $wireguard_config ]
          then
            g_echo "No wireguard configuration found in $wireguard_configs"
            exit 0
          fi
          g_echo "using config $wireguard_config"

          ## Tor withount wireguard
          novpnroute=$(ip route | grep default | awk '{print $3}')
          novpndev=$(ip route | grep default | awk '{print $5}')
          toruid=$(getent passwd debian-tor | cut -d: -f3)
          # check for routing-table-alias
          if ! grep -q "101 nowireguard" /etc/iproute2/rt_tables
          then
            g_echo "adding 101 nowireguard routingtable to /etc/iproute2/rt_tables"
            echo "101 nowireguard" >>/etc/iproute2/rt_tables
          fi
          # check for nowireguard route
          if ! ip route list table nowireguard | egrep -q "^default via $novpnroute dev $novpndev" 
          then
            g_echo "adding route via $novpnroute dev $novpndev for nowireguard routing tabe"
            ip route add default via $novpnroute dev $novpndev table nowireguard
          fi
          # check for nowireguard rule for tor uid
          if ! ip rule list | egrep -q "from all uidrange $toruid-$toruid lookup nowireguard"
          then
            g_echo "adding rule from all uidrange $toruid-$toruid lookup nowireguard"
            ip rule add from all uidrange $toruid-$toruid lookup nowireguard
          fi
          
          # Lockfiles
          while [[ -s /var/lock/dnstest.sh.lock ]]
          do
            g_echo "Waiting for /var/lock/dnstest.sh.lock"
            sleep 1
          done
          g_lockfile

          wgdnsip=$(grep "^DNS" $wireguard_config | cut -d= -f2 | cut -d, -f1)

          # look for known issue (happens in some cases afer machine reboot)
          nmcli connection | grep -q " wg-client" && if ! ping -c1 $wgdnsip >$g_tmp/ping_out 2>&1
          then
            if grep -q 'ping: sendmsg: ' $g_tmp/ping_out
            then
              g_echo "Known routing or whatever failure when network isn't up fast enough - "
              nmcli connection down wg-client
              nmcli connection up wg-client
            fi
            rm -f $g_tmp/ping_out
          fi

          if ping -c3 $wgdnsip >$g_tmp/ping_out 2>&1
          then
            g_echo "wireguard connection OK"
            exit 0
          fi

          g_echo "No wireguard connection"

          wghost=$(grep "^Endpoint" $wireguard_config | cut -d= -f2 | cut -d: -f1)
          if ! host -W5 $wghost >/dev/null 2>&1
          then
            g_echo_warn "DNS for $wghost not working"
            exit 1
          fi

          nmcli connection | grep -q "^wg-client" || \
          if nmcli connection import type wireguard file $wireguard_config
          then
            nmcli connection up wg-client
          else
            g_echo_error "Failed to import Wireguard VPN file $wireguard_config"
            exit 2
          fi

          # (re)connect wireguard if not deactivated in nm
          if nmcli connection | grep -q " wg-client"
          then
            g_echo_warn "reconnecting wg-client"
            nmcli connection down wg-client
            nmcli connection up wg-client
            exit 3
          fi
        backup: yes
        validate: /bin/bash -n %s

    - name: /usr/local/sbin/wireguard.sh shebang
      lineinfile:
        path: /usr/local/sbin/wireguard.sh
        insertbefore: BOF
        line: "#!/bin/bash"

    - name: Schedule WireGuard script in cron
      ansible.builtin.cron:
        name: "WireGuard Script"
        minute: "*"
        hour: "*"
        day: "*"
        month: "*"
        weekday: "*"
        user: "root"
        job: "/usr/local/sbin/wireguard.sh >>/var/log/wireguard.sh.log 2>&1"

    - name: Schedule WireGuard script @reboot
      ansible.builtin.cron:
        name: "WireGuard Script Reboot"
        special_time: reboot
        user: "root"
        job: "/usr/local/sbin/wireguard.sh >>/var/log/wireguard.sh.log 2>&1"
        state: present

