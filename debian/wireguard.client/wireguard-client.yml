---
- name: wireguard client
  hosts: all
  tasks:

    - name: Packages for wireguard
      apt:
        name:
          - wireguard
          - network-manager
        update_cache: no
        install_recommends: no

    - name: activate wireguard logging
      blockinfile:
        path: /etc/modprobe.d/wireguard.conf
        create: yes
        mode: "0444"
        owner: root
        group: root
        marker: "# {mark} ANSIBLE MANAGED BLOCK for wireguard"
        insertbefore: BOF
        block: |
          options wireguard dyndbg=+p
          
    - name: load wireguard module during boot
      blockinfile:
        path: /etc/modules-load.d/wireguard.conf
        create: yes
        mode: "0444"
        owner: root
        group: root
        marker: "# {mark} ANSIBLE MANAGED BLOCK for wireguard"
        insertbefore: BOF
        block: |
          wireguard
          
    - name: /usr/local/sbin/wireguard.sh
      blockinfile:
        path: /usr/local/sbin/wireguard.sh
        create: yes
        mode: 0500
        owner: root
        group: root
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
        block: |
          . /etc/bash/gaboshlib.include

          g_echo "=== Starting $0"

          while [[ -s /var/lock/dnstest.sh.lock ]]
          do
            g_echo "Waiting for /var/lock/dnstest.sh.lock"
            sleep 1
          done


          g_lockfile

          wireguard_config="/root/wg-client.conf"
          if ! [ -s $wireguard_config ]
          then
            g_echo "No wireguard configuration in $wireguard_config"
            exit 0
          fi

          wgdnsip=$(grep "^DNS" $wireguard_config | cut -d= -f2 | cut -d, -f1)

          # look for known issue (happens in some cases afer machine reboot)
          nmcli connection | grep -q " wg-client" && if ! ping -c1 $wgdnsip >$g_tmp/ping_out 2>&1
          then
            if grep -q 'ping: sendmsg: Destination address required' $g_tmp/ping_out
            then
              g_echo "Known routing or whatever failure when network isn't up fast enough - "
              nmcli connection down wg-client
              nmcli connection up wg-client
              systemctl restart tor.service
            fi
            rm -f $g_tmp/ping_out
          fi

          while [[ -s /var/lock/dnstest.sh.lock ]]
          do
            g_echo "Waiting for /var/lock/dnstest.sh.lock"
            sleep 1
          done

          [ -s $wireguard_config ] || exit 0

          if ping -c3 $wgdnsip >$g_tmp/ping_out 2>&1
          then
            cat $g_tmp/ping_out
            g_echo "wireguard connection OK"
            exit 0
          fi

          g_echo "No wireguard connection"

          wghost=$(grep "^Endpoint" $wireguard_config | cut -d= -f2 | cut -d: -f1)
          if ! host -W5 $wghost
          then
            g_echo_warn "DNS for $wghost not working"
            #g_check_fix_dns_stack
            # maybe vpn is blocking dns - if active remove
            #if nmcli connection | grep -q " wg-client"
            #then
            #  g_echo_warn "removing wg-client - maybe its blocking DNS/Internet access"
            #  nmcli connection down wg-client
            #  nmcli connection delete wg-client
            #  g_check_fix_dns_stack
            #fi
            exit 1
          fi

          nmcli connection | grep -q "^wg-client" || \
          if ! nmcli connection import type wireguard file $wireguard_config
          then
            g_echo_error "Failed to import Wireguard VPN file $wireguard_config"
            exit 2
          fi

          # (re)connect wireguard if not deactivated in nm
          if nmcli connection | grep -q " wg-client"
          then
            g_echo_warn "reconnecting wg-client"
            nmcli connection down wg-client
            nmcli connection up wg-client
            #g_check_fix_dns_stack
            exit 3
          fi
        backup: yes
        validate: /bin/bash -n %s

    - name: /usr/local/sbin/wireguard.sh shebang
      lineinfile:
        path: /usr/local/sbin/wireguard.sh
        insertbefore: BOF
        line: "#!/bin/bash"

    - name: Schedule WireGuard script in cron
      ansible.builtin.cron:
        name: "WireGuard Script"
        minute: "*"
        hour: "*"
        day: "*"
        month: "*"
        weekday: "*"
        user: "root"
        job: "/usr/local/sbin/wireguard.sh >>/var/log/wireguard.sh.log 2>&1"

    - name: Schedule WireGuard script @reboot
      ansible.builtin.cron:
        name: "WireGuard Script Reboot"
        special_time: reboot
        user: "root"
        job: "/usr/local/sbin/wireguard.sh >>/var/log/wireguard.sh.log 2>&1"
        state: present

