---
- name: openvpn server for br-lan
  hosts: all
  gather_facts: no

  vars:
    openwrt_packages:
      - openvpn
      - luci-app-openvpn
      - luci-i18n-openvpn-de
      - openvpn-easy-rsa
      - openssh-keygen

    uci_delete_vars:
      - openvpn.custom_config
      - openvpn.sample_server
      - openvpn.sample_client

    uci_vars:
      # openvpn server
      - { key: "openvpn.lanvpn", value: "openvpn" }
      - { key: "openvpn.lanvpn.enabled", value: "1" }
      - { key: "openvpn.lanvpn.port", value: "1196" }
      - { key: "openvpn.lanvpn.local", value: "::" }
      - { key: "openvpn.lanvpn.proto", value: "udp" }
      - { key: "openvpn.lanvpn.dev", value: "tap0" }
      - { key: "openvpn.lanvpn.mode", value: "server" }
      - { key: "openvpn.lanvpn.client_to_client", value: "1" }
      - { key: "openvpn.lanvpn.ca", value: "/etc/openvpn/lan-easy-rsa/pki/ca.crt" }
      - { key: "openvpn.lanvpn.cert", value: "/etc/openvpn/lan-easy-rsa/pki/issued/openvpn-server.crt" }
      - { key: "openvpn.lanvpn.key", value: "/etc/openvpn/lan-easy-rsa/pki/private/openvpn-server.key" }
      - { key: "openvpn.lanvpn.dh", value: "/etc/openvpn/dh.pem" }

      - { key: "openvpn.lanvpn.keepalive", value: "10 120" }
      - { key: "openvpn.lanvpn.cipher", value: "AES-256-CBC" }
      - { key: "openvpn.lanvpn.auth", value: "SHA256" }
      - { key: "openvpn.lanvpn.tls_server", value: "1" }

      - { key: "openvpn.lanvpn.user", value: "nobody" }
      - { key: "openvpn.lanvpn.group", value: "nogroup" }

      - { key: "openvpn.lanvpn.persist_key", value: "1" }
      - { key: "openvpn.lanvpn.persist_tun", value: "1" }

      - { key: "openvpn.lanvpn.status", value: "/var/log/openvpn-lan-status.log" }
      - { key: "openvpn.lanvpn.verb", value: "3" }
      - { key: "openvpn.lanvpn.explicit_exit_notify", value: "1" }

      - { key: "openvpn.lanvpn.script_security", value: "2" }
      - { key: "openvpn.lanvpn.up", value: "/etc/openvpn/lan-dev2bridge.sh" }

      - { key: "firewall.rule_allowopenvpn_lanvpn",      value: "rule" }
      - { key: "firewall.rule_allowopenvpn_lanvpn.name",      value: "ansible_allowopenvpn_lanvpn" }
      - { key: "firewall.rule_allowopenvpn_lanvpn.src",       value: "wan" }
      - { key: "firewall.rule_allowopenvpn_lanvpn.proto",     value: "udp" }
      - { key: "firewall.rule_allowopenvpn_lanvpn.dest_port", value: "1196" }
      - { key: "firewall.rule_allowopenvpn_lanvpn.target",    value: "ACCEPT" }

  tasks:
    - name: update opkg db
      raw: opkg update
      changed_when: false
  
    - name: check installed packages
      raw: opkg list-installed
      register: installed_packages
      changed_when: false

    - name: install packages if needed
      raw: opkg install {{ item }}
      loop: "{{ openwrt_packages }}"
      when: item not in installed_packages.stdout

    - name: detele config defaults
      raw: |
        # detele default config indices
        while uci show | grep -q "^{{ item }}="
        do
          echo "{{ item }}" >/tmp/x
          echo "changed"
          uci delete {{ item }}[0]
          uci delete {{ item }}
        done
      loop: "{{ uci_delete_vars }}"
      register: uci_delete_result
      changed_when: "'changed' in uci_delete_result.stdout"


    - name: hotplug skript if br-lan is restarted
      raw: |
        cat << 'EOF' >/etc/hotplug.d/iface/99-openvpn-br-lan
        [ "$ACTION" = "ifup" -a "$INTERFACE" = "br-lan" ] && {
          #echo 1 >/proc/sys/net/ipv6/conf/br-lan/disable_ipv6
          /sbin/ip link set dev tap0 master br-lan
        }
        EOF
        chmod 644 /etc/hotplug.d/iface/99-openvpn-br-lan
      changed_when: false

    - name: /etc/openvpn/lan-dev2bridge.sh
      raw: |
        cat << 'EOF' > /etc/openvpn/lan-dev2bridge.sh
        #!/bin/bash
        
        # OpenVPN Up Script to add tap to bridge
        # get dynamically added tap device
        tap=$dev

        # disable ipv6
        echo 1 >/proc/sys/net/ipv6/conf/${dev}/disable_ipv6

        # set tap interface up without IP
        /sbin/ip link set dev $tap up
        /sbin/ip addr flush dev $tap

        # add tap interface to bridge br-lan
        /sbin/ip link set dev $tap master br-lan

        # set promisc mode for tap
        /sbin/ip link set dev $tap promisc on
        EOF
        chmod 500 /etc/openvpn/lan-dev2bridge.sh
      changed_when: false

    - name: create script for easy-rsa pki and cronjob
      raw: |
        mkdir -p /etc/scripts
        cat << 'EOF' > /etc/scripts/openvpn-lan-easyrsa.sh
        #!/bin/bash

        VPNNAME="lan"
        EASYRSA_DIR="/etc/openvpn/${VPNNAME}-easy-rsa.tmp"
        EASYRSA_DIR_FINAL="/etc/openvpn/${VPNNAME}-easy-rsa"
        OPENVPN_DIR="/etc/openvpn"
        CLIENT_NAME="${1}.${VPNNAME}"
        CERT_DAYS=30

        # cleanup/remove old cert chain
        cd /tmp
        rm -rf ${EASYRSA_DIR}
        mkdir -p ${EASYRSA_DIR}
        chmod 700 ${EASYRSA_DIR}
        cd ${EASYRSA_DIR} || exit 1

        # generate new cert chain
        /usr/bin/easyrsa --batch init-pki || exit 2
        /usr/bin/easyrsa --batch --days=${CERT_DAYS} build-ca nopass || exit 3
        [ -s "${OPENVPN_DIR}/dh.pem" ] || openssl dhparam -out ${OPENVPN_DIR}/dh.pem 2048 || exit 4
        /usr/bin/easyrsa --batch --days=${CERT_DAYS} build-server-full openvpn-server nopass || exit 5

        # go through clients
        for CLIENT_HOSTNAME in {{ clients }}
        do
          CLIENT_NAME=${CLIENT_HOSTNAME}.${VPNNAME}

          # generate client cert
          /usr/bin/easyrsa --batch --days="$CERT_DAYS" build-client-full "$CLIENT_NAME" nopass || exit 6

          # generate client .ovpn-file
          CA_CRT="$EASYRSA_DIR/pki/ca.crt"
          CLIENT_CRT="$EASYRSA_DIR/pki/issued/$CLIENT_NAME.crt"
          CLIENT_KEY="$EASYRSA_DIR/pki/private/$CLIENT_NAME.key"

          echo "client
          dev tap0
          proto udp
          remote $(uci get ddns.dedyn_ipv6_openwrt.domain) 1196
          resolv-retry infinite
          nobind
          persist-key
          persist-tun
          ca [inline]
          cert [inline]
          key [inline]
          #cipher AES-256-CBC
          data-ciphers AES-256-GCM:AES-128-GCM:CHACHA20-POLY1305
          data-ciphers-fallback AES-256-GCM
          auth SHA256
          verb 3
          remote-cert-tls server
          script-security 2
          up /etc/openvpn/${VPNNAME}-dev2bridge.sh
          #log /var/log/openvpn-${VPNNAME}.log

          <ca>
          $(cat "$CA_CRT")
          </ca>
          <cert>
          $(cat "$CLIENT_CRT")
          </cert>
          <key>
          $(cat "$CLIENT_KEY")
          </key>" >"${CLIENT_NAME}.ovpn"
         
          sed -i 's/^[[:space:]]*-----/-----/' "${CLIENT_NAME}.ovpn"

          # stop here if homeassistant (server) client
          [[ $CLIENT_HOSTNAME = homeassistant ]] && continue

          # push to client
          ssh -o StrictHostKeyChecking=accept-new -o BatchMode=yes ${CLIENT_HOSTNAME} "echo OK" || continue
          # copy openvpn client config
          scp -B -O -q "${CLIENT_NAME}.ovpn" /etc/openvpn/lan-dev2bridge.sh ${CLIENT_HOSTNAME}:/etc/openvpn
          scp -B -O -q /etc/hotplug.d/iface/99-openvpn-br-lan ${CLIENT_HOSTNAME}:/etc/hotplug.d/iface/99-openvpn-br-lan
          # add vpn client
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "uci set openvpn.lanvpn=openvpn"
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "uci set openvpn.lanvpn.config=/etc/openvpn/${CLIENT_NAME}.ovpn"
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "uci set openvpn.lanvpn.verb='3'"
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "uci set openvpn.lanvpn.enabled='1'"
          # add bridge br-lan
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "uci set network.lan_dev='device'"
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "uci set network.lan_dev.name='br-lan'"
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "uci set network.lan_dev.type='bridge'"
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "uci set network.lan_dev.bridge_empty='1'"
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "uci set network.lan='interface'"
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "uci set network.lan.device='br-lan'"
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "uci set network.lan.proto='none'"
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "uci set network.lan.defaultroute='0'"
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "uci set network.lan.delegate='0'"
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "uci commit"
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "/etc/init.d/network reload"
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "/etc/init.d/openvpn enable"
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "/etc/init.d/openvpn restart"

          ssh -o StrictHostKeyChecking=accept-new -o BatchMode=yes ${CLIENT_HOSTNAME} "mkdir -p /etc/scripts"
          scp -B -O -p -q /etc/scripts/openvpn-lan-tap-in-bridge.sh ${CLIENT_HOSTNAME}:/etc/scripts/
          ssh -o BatchMode=yes ${CLIENT_HOSTNAME} "grep -Fq \"$cronjob\" /etc/crontabs/root || echo \"$cronjob\" >>/etc/crontabs/root"

        done

        # use/activate new pki
        rm -rf ${EASYRSA_DIR_FINAL}.old
        [ -e "${EASYRSA_DIR_FINAL}" ] && mv ${EASYRSA_DIR_FINAL} ${EASYRSA_DIR_FINAL}.old
        mv ${EASYRSA_DIR} ${EASYRSA_DIR_FINAL}
        /etc/init.d/openvpn restart

        EOF

        chmod 500 /etc/scripts/openvpn-lan-easyrsa.sh
        [ -s /etc/openvpn/lan-easy-rsa/pki/issued/openvpn-server.crt ] || /etc/scripts/openvpn-lan-easyrsa.sh

        cronjob="45 5 * * *   /etc/scripts/openvpn-lan-easyrsa.sh"
        grep -Fq "$cronjob" /etc/crontabs/root || echo "$cronjob" >>/etc/crontabs/root
      changed_when: false

    - name: create script for add tap in bridge if not in
      raw: |
        cat << 'EOF' > /etc/scripts/openvpn-lan-tap-in-bridge.sh
        #!/bin/bash

        DEV="tap0"
        BR="br-lan"

        # does dev exist?
        if ! ip link show "$DEV" >/dev/null 2>&1
        then
          echo "Error: Device $DEV does not exist"
          exit 1
        fi

        # does bridge exist?
        if ! brctl show "$BR" 2>/dev/null | grep -q "^$BR"
        then
          echo "Error: Bridge $BR does not exist"
          exit 2
        fi

        # add device to bridge if not in
        if ! brctl show "$BR" | grep -q "$DEV"
        then
          brctl addif "$BR" "$DEV"
        fi

        # set promisc mode on device
        ip link set dev "$DEV" promisc on

        # up device
        ip link set dev "$DEV" up

        EOF

        chmod 500 /etc/scripts/openvpn-lan-tap-in-bridge.sh

        cronjob="*/5 * * * *   /etc/scripts/openvpn-lan-tap-in-bridge.sh"
        grep -Fq "$cronjob" /etc/crontabs/root || echo "$cronjob" >>/etc/crontabs/root
      changed_when: false

    - name: set uci values if needed
      raw: |
        current=$(uci get {{ item.key }} 2>/dev/null || echo "NOT_SET")
        desired="{{ item.value }}"
        if [ "$current" != "$desired" ]
        then
          uci set {{ item.key }}="{{ item.value }}"
          echo "changed"
        else
          echo "unchanged"
        fi
      loop: "{{ uci_vars }}"
      register: uci_set_result
      changed_when: "not 'unchanged' in uci_set_result.stdout"

    - name: apply changes
      block:
        - name: commit enable and restart
          raw: "{{ item }}"
          loop:
            - "uci commit"
            - "/etc/init.d/openvpn restart"
            - "/etc/init.d/firewall reload"
          when: uci_set_result.changed

